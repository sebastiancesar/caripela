import { Component, ViewChild, ElementRef, AfterViewInit } from '@angular/core';
import { Reco } from '../../modules/reco/reco';

const IMG_WIDTH = 224;
const IMG_HEIGHT = 224;

@Component({
  selector: 'page-home',
  templateUrl: 'home.html'
})
export class HomePage implements AfterViewInit {
  @ViewChild('webcamholder') 
  private webcamholder: ElementRef;

  previews = { 0: '', 1: '', 2: '', 3: '' };
  caripela: Reco;

  canvas: HTMLCanvasElement = document.createElement('canvas');
  context2d = this.canvas.getContext('2d');
  lastPrediction = { classId: -1, confidence: -1 };

  samplesAdded = { 0: 0, 1: 0, 2: 0, 3:0 };
  constructor () {    
    this.caripela = new Reco(this.lastPrediction);
    this.canvas.height = IMG_HEIGHT;
    this.canvas.width = IMG_WIDTH;
  }

  reset () {
    this.caripela.reset();
    this.samplesAdded = {0: 0, 1: 0, 2: 0, 3:0 };
    this.previews = { 0: '', 1: '', 2: '', 3: '' };
  }
  
  train () {
    this.caripela.train();
  }

  start () {
    this.caripela.start();
  }

  stop () {
    this.caripela.stop();
  }

  addSamples (classId) {
    this.caripela.addSamples(classId, this.samplesAdded);
    this.samplesAdded[classId] += 1;
    this._drawThumb(this.caripela.getWebcamElement(), classId);
  }

  _drawThumb (webcamElement, classId) {    
    this.context2d.drawImage(webcamElement, 0, 0, IMG_WIDTH, IMG_HEIGHT);
    this.previews[classId] = this.canvas.toDataURL();         
  }

  ngAfterViewInit (): void {
    this.caripela.init(this.webcamholder.nativeElement)
      .then((recoCreated) => {
        console.log('caripela created');
      });
  }
}
